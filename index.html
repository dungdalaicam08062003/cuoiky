<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Vehicle Monitor</title>

    <style>
      body {
        font-family: Arial;
        background: #f2f4f8;
        padding: 20px;
      }
      .box {
        width: 340px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px #ccc;
        margin-bottom: 15px;
      }
      .offline {
        color: red;
        font-weight: bold;
      }
      iframe {
        width: 100%;
        height: 250px;
        border: none;
        border-radius: 8px;
      }
    </style>
  </head>

  <body>
    <h2>ğŸš— TRáº NG THÃI XE</h2>

    <div class="box">
      <p>
        Nhiá»‡t Ä‘á»™: <b><span id="temp">--</span> Â°C</b>
      </p>
      <p>
        Cá»­a: <b><span id="door">--</span></b>
      </p>
      <p>
        Tráº¡ng thÃ¡i: <b><span id="vehicle">--</span></b>
      </p>
      <p>
        Vá»‹ trÃ­: <b><span id="lat">--</span>, <span id="lng">--</span></b>
      </p>
      <p id="offline" class="offline"></p>
    </div>

    <div class="box">
      <h4>ğŸ“ Báº¢N Äá»’</h4>
      <iframe id="map" src=""></iframe>
    </div>

    <script>
      const URL = "https://vehicles-3b445-default-rtdb.firebaseio.com/car.json";

      function vehicleText(v) {
        if (v == 1) return "BÃ¬nh thÆ°á»ng";
        if (v == 2) return "ÄÆ°á»ng xáº¥u";
        if (v == 3) return "Xe nghiÃªng";
        if (v == 4) return "Va cháº¡m";
        return "KhÃ´ng rÃµ";
      }

      function loadData() {
        fetch(URL)
          .then((res) => res.json())
          .then((data) => {
            if (!data) return;

            document.getElementById("temp").innerText = data.temp ?? "--";
            document.getElementById("door").innerText =
              data.door == 0 ? "ÄÃ³ng" : "Má»Ÿ";

            document.getElementById("vehicle").innerText = vehicleText(
              data.vehicle_state
            );

            document.getElementById("lat").innerText = data.lat;
            document.getElementById("lng").innerText = data.lng;

            // ===== MAP =====
            if (data.lat && data.lng) {
              document.getElementById(
                "map"
              ).src = `https://www.google.com/maps?q=${data.lat},${data.lng}&z=16&output=embed`;
            }

            // ===== OFFLINE CHECK (SERVER TIME) =====
            let now = Math.floor(Date.now() / 1000);
            if (now - data.lastUpdate > 300) {
              document.getElementById("offline").innerText =
                "âš ï¸ XE OFFLINE (>5 phÃºt)";
            } else {
              document.getElementById("offline").innerText = "";
            }
          })
          .catch((err) => {
            document.getElementById("offline").innerText =
              "âŒ Lá»–I Káº¾T Ná»I FIREBASE";
            console.error(err);
          });
      }

      // ğŸ” Update má»—i 2 giÃ¢y
      setInterval(loadData, 2000);
      loadData();
    </script>
  </body>
</html>
