<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Vehicle Telematics Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        font-family: Arial;
        background: #f2f4f8;
        padding: 20px;
      }

      h2 {
        margin-bottom: 15px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .box {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px #ccc;
      }

      .offline {
        color: red;
        font-weight: bold;
      }

      iframe {
        width: 100%;
        height: 320px;
        border: none;
        border-radius: 8px;
      }

      canvas {
        max-height: 300px;
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <h2>üöó H·ªÜ TH·ªêNG GI√ÅM S√ÅT XE (TELEMATICS)</h2>

    <!-- ===== STATUS + MAP ===== -->
    <div class="grid">
      <!-- LEFT -->
      <div class="box">
        <p>
          Nhi·ªát ƒë·ªô: <b><span id="temp">--</span> ¬∞C</b>
        </p>
        <p>
          C·ª≠a: <b><span id="door">--</span></b>
        </p>
        <p>
          Tr·∫°ng th√°i xe: <b><span id="vehicle">--</span></b>
        </p>
        <p>
          V·ªã tr√≠: <b><span id="lat">--</span>, <span id="lng">--</span></b>
        </p>
        <p id="offline" class="offline"></p>
      </div>

      <!-- RIGHT -->
      <div class="box">
        <h4>üìç B·∫¢N ƒê·ªí GPS</h4>
        <iframe id="map"></iframe>
      </div>
    </div>

    <!-- ===== CHART ===== -->
    <div class="box" style="margin-top: 20px">
      <h4>üå°Ô∏è BI·ªÇU ƒê·ªí NHI·ªÜT ƒê·ªò</h4>
      <canvas id="tempChart"></canvas>
    </div>

    <script>
      const URL =
        "https://vehicles-3b445-default-rtdb.firebaseio.com/car/latest.json";

      // ===== VEHICLE TEXT =====
      function vehicleText(v) {
        if (v == 1) return "B√¨nh th∆∞·ªùng";
        if (v == 2) return "ƒê∆∞·ªùng x·∫•u";
        if (v == 3) return "Xe nghi√™ng";
        if (v == 4) return "Va ch·∫°m";
        return "Kh√¥ng r√µ";
      }

      // ===== CHART INIT =====
      const ctx = document.getElementById("tempChart").getContext("2d");

      const tempChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Nhi·ªát ƒë·ªô (¬∞C)",
              data: [],
              borderColor: "red",
              tension: 0.3,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: { display: true, text: "Th·ªùi gian" },
            },
            y: {
              title: { display: true, text: "¬∞C" },
            },
          },
        },
      });

      function addTempPoint(temp) {
        const time = new Date().toLocaleTimeString();

        tempChart.data.labels.push(time);
        tempChart.data.datasets[0].data.push(temp);

        if (tempChart.data.labels.length > 20) {
          tempChart.data.labels.shift();
          tempChart.data.datasets[0].data.shift();
        }

        tempChart.update();
      }

      // ===== LOAD DATA =====
      function loadData() {
        fetch(URL)
          .then((res) => res.json())
          .then((data) => {
            if (!data) return;

            document.getElementById("temp").innerText = data.temp ?? "--";
            document.getElementById("door").innerText =
              data.door == 0 ? "ƒê√≥ng" : "M·ªü";

            document.getElementById("vehicle").innerText = vehicleText(
              data.vehicle_state
            );

            document.getElementById("lat").innerText = data.lat;
            document.getElementById("lng").innerText = data.lng;

            // MAP
            if (data.lat && data.lng) {
              document.getElementById(
                "map"
              ).src = `https://www.google.com/maps?q=${data.lat},${data.lng}&z=16&output=embed`;
            }

            // OFFLINE CHECK
            let now = Math.floor(Date.now() / 1000);
            if (now - data.lastUpdate > 300) {
              document.getElementById("offline").innerText =
                "‚ö†Ô∏è XE OFFLINE (>5 ph√∫t)";
            } else {
              document.getElementById("offline").innerText =
                "‚úÖ Xe ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng";
            }

            // ADD TO CHART
            if (typeof data.temp === "number") {
              addTempPoint(data.temp);
            }
          })
          .catch((err) => {
            document.getElementById("offline").innerText =
              "‚ùå L·ªñI K·∫æT N·ªêI FIREBASE";
            console.error(err);
          });
      }

      setInterval(loadData, 2000);
      loadData();
    </script>
  </body>
</html>
